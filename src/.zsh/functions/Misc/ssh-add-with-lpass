main() {
  if type ssh-add expect >/dev/null 2>&1; then
    if [ -n "$1" ]; then
      REMOTE_HOST=$1
    else
      echo "missing argument"
      echo "usage: ssh-add -p [remote_hostname]\n"
      return 1
    fi

    if type lpass >/dev/null 2>&1; then
      if [ -e ~/.lpass/username ]; then
        identity-add
      else
        echo "Error: You need to login lastpass."
        printf "  Username: "
        read LASTPASS_USERNAME
        printf "  "
        if ! lpass login $LASTPASS_USERNAME; then
          return 1
        fi
        identity-add
      fi
    else
      echo "Error: You need to install \`lpass\`."
      return 1
    fi
  else
    if ! type ssh-add expect >/dev/null 2>&1; then
      echo "Error: You need to install \`ssh-add\` and \`expect\`."
    elif type ssh-add >/dev/null 2>&1; then
      echo "Error: You need to install \`ssh-add\`."
    elif type expect >/dev/null 2>&1; then
      echo "Error: You need to install \`expect\`."
    fi
  fi
}

identity-add() {
  PASSPHRASE=`lpass show --field=Passphrase ${REMOTE_HOST}\(${USER}@$(hostname -s)\)`
  SSH_KEY_PATH=${HOME}/.ssh/key/${REMOTE_HOST}
  expect -c "
  spawn ssh-add $SSH_KEY_PATH
  expect \"Enter passphrase for ${SSH_KEY_PATH}:\"
  send -- \"${PASSPHRASE}\n\"
  expect \"$\"
  exit 0
  " >/dev/null 2>&1
  echo "Identity added: $SSH_KEY_PATH"
}
main $@
# vim: ft=zsh sw=2 ts=2 et
