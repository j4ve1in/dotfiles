local base_path="$(git rev-parse --show-cdup | sed 's%/%\\/%g')"
FILES=($(git status --porcelain | sed "s/^\(..\) /\1\t${base_path}/" | grep "^.[MD?]" | $SELECTOR | awk '{print $2}'))
[ -z "$FILES" ] && return 1
for file in ${FILES[@]}; do
  [ ! -f "$file" ] && return 1
done
if zle; then
  BUFFER="git add -- ${FILES[@]}"
  CURSOR=$#BUFFER
  zle accept-line
  zle -R -c
else
  print -z -f '%s' "git add -- ${FILES[@]}"
fi
# vim: ft=zsh sw=2 ts=2 et
