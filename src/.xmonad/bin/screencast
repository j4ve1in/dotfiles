#!/bin/zsh

main() {
  if ! killall ffmpeg; then
    if [ "$1" = "--select" ]; then
      if [ -f /tmp/unclutter.pid ]; then
        unclutter-toggle
        screencast-select
        unclutter-toggle
      else
        screencast-select
      fi
    else
      screencast-full
    fi
  fi
}

screencast() {
  typeset size display file
  size="$1"
  display="$2"
  file=~/Videos/Screencasts/screencast_$(date +'%y-%m-%d_%I%M%S').mkv
  ffmpeg -f x11grab -s "$size" -i "$display" -f alsa -i default -c:v libx264 -c:a aac "$file"
  notify-send 'Recorded screen' "Saved to $file"
}

screencast-full() {
  typeset size
  size=`xwininfo -root | awk '/-geo/{print $2}' | grep -Eo '^[0-9]*x[0-9]*'`
  screencast "$size" "$DISPLAY"
}

screencast-select() {
  eval $(slop)
  screencast "$W"x"$H" :0.0+$X,$Y
}

main $@
