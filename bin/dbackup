#!/bin/zsh

typeset -g CMDNAME=${0##*/}

. dbase && . dcore

cprint 'Backup dotfiles' $UNDERLINE
cd "$DROOT"
export GIT_{AUTHOR,COMMITTER}_NAME="$CMDNAME"
export GIT_{AUTHOR,COMMITTER}_EMAIL="$CMDNAME@example.com"
git stash >/dev/null 2>&1
git checkout master >/dev/null 2>&1

# create branch
BACKUP_BRANCH="backup/$(date +'%Y%m%d%H%M%S')"
lprintf ' Switching to a backup branch' "git checkout --orphan $BACKUP_BRANCH"
printf '  master'
cprintf ' -> ' $COLOR_93_B
print "$BACKUP_BRANCH"

# commit
echo ' Commit to a backup branch'
git commit -m "backup dotfiles" | sed -n 2p | sed 's/^/ /g'
echo ' If you want to roll back, run the following command.'
echo "   $(cprintf '$' $COLOR_75_B) git -C "$DROOT" checkout $BACKUP_BRANCH"

git checkout master >/dev/null 2>&1
git stash pop >/dev/null 2>&1
unset GIT_{AUTHOR,COMMITTER}_NAME GIT_{AUTHOR,COMMITTER}_EMAIL
cd - >/dev/null 2>&1
echo
